name: "CI: Check Lint"

on:
  pull_request:
    paths:
      - ".github/workflows/ci-lint.yaml"
      - "apps/backend/**"
      - "apps/frontend/**"
      - "apps/ag-frontend/**"
      - "apps/datapuller/**"
      - "packages/**"

jobs:
  lint:
    name: Lint Codebase
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Lint
        id: lint
        run: npm run lint -- --continue --output-logs=errors-only > lint-output.txt 2>&1
        continue-on-error: true

      - name: Post Lint Report
        if: steps.lint.outcome == 'failure'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('lint-output.txt', 'utf8');

            // Truncate if too long to avoid API limits
            const maxLength = 60000;
            let cleanOutput = output;
            if (output.length > maxLength) {
              cleanOutput = output.substring(0, maxLength) + '\n... (output truncated)';
            }

            const body = `### Linting Failed

            Note: The status check will always pass. Run \`npm run lint -- --continue\` to see the full output locally.

            <details>
            <summary>Click to expand lint output</summary>

            \`\`\`
            ${cleanOutput}
            \`\`\`

            </details>
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

            core.setFailed('Linting failed');
