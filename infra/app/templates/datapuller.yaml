{{ define "bt-app.datapuller" }}
{{- $root := index . 0 -}}
{{- $jobName := index . 1 -}}
{{- $jobConfig := index . 2 -}}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "bt-app.datapullerName" $root }}-{{ $jobName }}
  labels:
    {{- include "bt-app.datapullerLabels" $root | nindent 4 }}
spec:
  schedule: "{{ $jobConfig.schedule }}"
  timeZone: America/Los_Angeles
  concurrencyPolicy: Forbid
  suspend: {{ $root.Values.datapuller.suspend }}
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 1
  jobTemplate:
    metadata:
      labels:
        {{- include "bt-app.datapullerLabels" $root | nindent 8 }}
    spec:
      ttlSecondsAfterFinished: 172800
      template:
        metadata:
          labels:
            {{- include "bt-app.datapullerLabels" $root | nindent 12 }}
        spec:
          containers:
            - name: datapuller-{{ $jobName }}
              image: {{ printf "%s/%s:%s" $root.Values.datapuller.image.registry $root.Values.datapuller.image.repository ( toString $root.Values.datapuller.image.tag ) }}
              imagePullPolicy: Always
              command: ["turbo", "run", "main", "--filter=datapuller", "--env-mode=loose", "--"]
              args: {{ $jobConfig.args | toYaml | nindent 16 }}
              envFrom:
                - configMapRef:
                    name: {{ include "bt-app.datapullerName" $root }}-env
                - secretRef:
                    name: {{ include "bt-app.datapullerName" $root }}-secret
          restartPolicy: OnFailure
{{ end }}

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "bt-app.datapullerName" . }}-env
  labels:
    {{- include "bt-app.datapullerLabels" . | nindent 4 }}
data:
  MONGODB_URI: {{ .Values.mongoUri }}
  TZ: America/Los_Angeles # for tslog
  BACKEND_URL: {{ printf "http://%s-svc.bt.svc.cluster.local:%v" (include "bt-app.backendName" .) .Values.backend.cacheWarmingPort }}

---

apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  annotations:
    sealedsecrets.bitnami.com/namespace-wide: "true"
  name: {{ include "bt-app.datapullerName" . }}-secret
  labels:
    {{- include "bt-app.datapullerLabels" . | nindent 4 }}
spec:
  encryptedData:
    AWS_ACCESS_KEY_ID: AgCpxxcvZf4RfcFlEi4Wf5QXXEMvIRW6FfR/OyJJBMqPYGTVQJUpOSV5DsjnWKYgftlpRK0obx8L4QfekVz7k50s4wogiZewPNYxlzeBQE0o5Ov1wIrtMlvZMR7V4pEKrBJxLHhP2YnURS3aPZrHov9fuUpdjd7Bkx+Gw0TSCHBsl3jO4SpYwc4BtzHQ4o7gU8nvACCBaYlYLhTwNgQe91IDUs2t7VIMvmK4cTyjDbqeLzMaPMwnxfn2wsKV+I6TtWIK7PUDfTB7PdsWCM+LxNw91z6FO3OdTKbPnOPmHStZjAndpk1ToIL84IcRjsrv5N6Far5sZJX+4FPWC9It3x1/+5uAXdkp/Jp/nkEXQDettdCB/WnGqME2hQ3gyzrgRLujpnOrRPnj6yWLoo2lGROJFeF1Wgn7Ug57wnnisp7QDMXOgaytR+4BV5SVPpBeho2doCRJZA8HK7DoaBCQvlf/tb4v4SW93VUGX0Ioxsa0rfPva4bqIL+hEt/l8RK4yjBhn/FMRIKWAubI7wID9ANCIpXwD4P/6UxND6CBUBAJ0k4pO9Yb0Eu3oWRfM/zL9/zo2p0mkLID3Ings9oGyKPbS0/aIGmMpsg0lERx0kHpiVhOJxN3dXuybDgpYpeNrUrW5EgICZAywWooiofJi1+G/oM8dcatGZ29xLdAfNuwoFaGe3zDUDmOWHN8NfwJeBX6gQ9outuwa+RW3JLUSUs+F85JIw==
    AWS_DATABASE: AgA+ym6XhzfMTLSbnC0lHaBZPapiu+vgH2a82vHdWBpspJQL2rG43rhMBP4q6TOy4+XUE9dBwBe3qcK2slBPWFHu6j1hxoy7yz+P54oqHRzl9CbpGSJONmzDO9i1q0gRoiwCOAMFPSTgydmpRnIbdOMRFMD3i+ddvyHnrWjhiasGLFn863ft0zKwOMgbxVl8xn3RoTFtK7ilb4dOz5iC/QsEcv/G2C7n4KQb43H5A8wmTxxEza3HAhFGBl45xbxduo2nh97zP2b8+9kNz1lEyFzeToSVPPsM1Xz7FomljAx2WlpwTadC5Fv8OCeKMn7L0svL1HfEG+w+RxsFnzvV/h7npD3zWltyalN1yxMWzkXPZSiwmm6KcWKOn53yCTWMyf8EoOPcgJPDt0HTHvKO/6Kue7LZgMgtcZKci0PHossyEnRKLx6aXvZaB0HjW473IO2c2IwZsAuKkDpkQPW9eZUrB5SQ+6G7iNKzVwEX2wa5SRh0IRBZSQRBzQGe0THm4SePidhaqqgX8jY6BeYgXxdTooXTmmyLEczySaJBHsyqrMjnSbJqUO3oyKqbHtm+y4WafUZwnEW9MEkjPpBKcqYwqsAStFjeSAbR79eE6PknK7Z1iQLOCoGzK3V2CvoDczWLsIHW5K3WmJ2wTXrN9K9UKUAaztlE3GArV9dS9J6CaFvSBqYCfMq8PVnx5eORc1ljks6s9NuV51RnTPkc
    AWS_REGION_NAME: AgBJXCzxFhkKDBlV8aaVfJsm1DHUi2GXMjQZuc3eGG1krS5liCrcNILfz9pfj2uKV6OhhpOEsQWjAP5sJau6vs+6kvJhHx1UduINseq9vGiHnulNcYWg9257ta35wjMm77lNqk7dj9aJEt95Ml+Ore4KE6KsQuV7yogRXBpNcO6TsfkynWJVrUAN3TNilml2qbhtwMyY+Xc/jB8jPxpM3XDbCd7zjxcbgR6/9nrZjNj9IYjm8I41RVOTn9Ucfr9AkgtqNkwaaB5G5oShD+N7wekH6xkZq6j8pIcAzBGVLXZJQTxhdRvNkUkhosRC6VPMO976DtQs7rBQEz8Di78AqjgNc9uJ9eTOlHy62lHx/MTZnh7vbBJtCQ5gQEyGelZnSXSn+ioIhSlQODZcwTiH6pmRtwVOpbhn51/JwwvC4qjIZZBxhfBa5L7xdlbpIScQjXlnrWEVhi10OnBUGDoFcTpcL2fsZUkNAu/7sZBsh1nplx0vC8jakJPHfPy5lidqO30fSltewiFvWIKrt3pt76NjE8bHaUxSu1419qVheyWQT1Gs6jNMbw2BHh+ml1xZgDP3cM7Nk+ko8zvlq2hCkyyk/mmB8u++LLevtzJpG73FyAAzgfK2rtaw2RkunhyPxKGLM9SjXhtMCddYh/g80k4k6vVyd7Aq8QKUSmiA1eq8T1fIgsacuB0MaJL1vYB4u1/oDCgQwwPOcI4=
    AWS_S3_OUTPUT: AgCGFcrI8BrywEc0os0MaYKfEQox9MDPwkvh6juU7Eq6wrbcet4ZYQGf1JeJjVmMs9GIAb1J24NVkoFL18CWsKl5XWXvN42lgqcoxwY61a2ybdVYA9jBgt6wiNYz1XNZ78t5XN1P+fpvnABNTU0gjGgzxwqosKyiSICvRM1sQ+ffYhdT8vS12TXj4SLuC+fJF8+rHXaODqRYzTUVO6ah0AmaQHzOLH/4XnsU9bzOssffFCB3aMAkEU4i+e9XxGlLeTFwL5HMKTI6siulQ0jjeUHdaRvrYSDxxIqYwjrV2LweH/QIljbp9Jai7+K09u6ETCvlA1pTY407VOb4UmplYJTSXFES/5v9IauaFPFAZjRepbSjqe5cW2nHZeEAGGfZ+AKScWkZGMrC3G4TjBNXe4z051W6HXtrQBJJNltN0+UQGet+iCEDUHwVum0tExD+fVWk2h5EtDS6j13wlyz44OdkwtZUpPdVJYnVg/5rN7YcczEFHPCvu8hQb/rsaLk+W7MseeXhZcQb1ngpwcFAWmAabwHaoeF5CaT4UAOliPQxUj05TfYjp4zORJvIvyM0D1SpCdgCbbNgjYuOboe73p0a571HUeUsmAlsCd5w86w0RmYj8UHJ2PCCjB6Ab0Kgic5W26UTHJaJo2nqIDpGyiPBi15S6/MmufJBS1gtHBMOUZ0rUi1988+Z9xGe4n8uYKPAXNfOMFGzQ1ihsYglxuaPXBtB7tWm+vO6MxQ6N/8Mr+rK481t3R1/ZE4ciebNer1NxJZLGA==
    AWS_SECRET_ACCESS_KEY: AgCqL9rnPz1oUHqlRGusAjKUXfUUcXZP65aUyULdtp2b2KK8w1fpijrlBfHSFLvKAhsYOdgvqIEQnV93J+Hy1dekD27SlI8NEFOca8qyze/Kbyy27v6ANXU1LO17D56grsZ3BLt2m+Zl6TM2XfT8+6ybD8je6yO8+U0XHOvoHrONRVZ64Yovq/Yrth1EkeR5hqtH0NMINNR7DJmWkKXYu13jRyij+v2h3+Eh0KTsiSVRp01Pmm2jA+fsZS8KH9SObkSDEdekdxrZ5eVx+vahHOpp1kqiW+P0UhUqgJIViaF7jff1S3qMyARvo5KmMapbtX5tyaFASxrn0bGqGN6OFXSlJCD5O3lbD6OF4Jfm3diu6ZCMdHxTkg1MdPJ0NX6OtxJ+Z5/+K1r1+XuMfmtvTI9Sn6/Z4LGIXTnzhJdUFt0Mdo73XxO4ozvOuaNaHdwq0i2unBMw5iSn4Xd8VyTM219KNhYXSIl5YJlHs9X3ZSEqYXWu94XfZ/8Y7hBY6hnHP+TSSuu/WjFVyyy+EAlDvNgb3vlk3Nzdfvun/18A5AFA+9dg+dNWc7BjzMBVu0ftGNE4Ru/DgAr13/eM9DPoPZF28d0BC96BCKsGP8JfVoor4iF3RzF+PILV/XHTCOTKsLm1RWjWWieA20DGiPj3gxHj8pqu1p0BOR/hhthIXxetP7Kgua9G88vxabiRjqaKvg2vYlbE8T4LGCle1wGYiB3VR/Te02vPHiRPn1LA4OCDc3ImRyOslc9Z
    AWS_WORKGROUP: AgBZcJvhvYaHbZ09CdY9bVe66dfyCqtueATHy4CBvOSknjR/JY8Z+gra8mjigrfcGICsi4eMmK3wr8WLiVLx+/25SNB5sG0nduy58lltUXIwAEykWgnRjuycCCt50HZJS2Dxpoud4sqHTbhiqB2h5FzMnb8xtwLFN0sVB7jRHCoABj/o5l9Iusrx+nkmpsA/DGf+CeMrNGFYNWR3peQB/ei9fPFpn8oZVpTMhnpuTiP5oGz4uHfcl0jxXqF1AZpuaQkWRbK2OOaVpO+soSCWo3Fx5isdNe2bIvbL7FhFR4IrF2j3Dviz9u1yPSkUo5KD7wBMbOjWitySJVKCLJX15wcV1MdOJRTjz7iRsli3oAjxh2JlZM18qIk5c8Itpv1xhfr0RyU8/z4dvSVGaXM7MSnxAk4kv/0rc7P5DBlnz2WvJKDla6fb5pkyTKBEdauRxZMe4K9Z+dGcmgpha1rtPKRzOrZEk6rq9HXI3uCvv57HkMukorxv3b1Rv7Hwg20jdKiKbKIQ9LAYZ1N1TIUjLzxPBu+QamQ0Xs4Va7IgFZ6UngnHw7spAT4hOskTt7x3JpNucGSdtOObzdrvaClC0FtzKHRdM8Jr3N603lXjp2xvDIvC7N1WrrkF7e0eX26gzXwj4+TIMLinPbVOJ+6rlMihXQu5F4pwUoECrZbUndCjYxbfv0+ALriTlv9kTbOAsokejH4oc3P93Q6MgJav0yLa6SOsMyPuHQCT
    SIS_CLASS_APP_ID: AgCdRWUCepeweJJroh8McWWa8cdTsT8NYoAm2/wJtN2Bzqtr3Og9NJEE4pPbRbAe+c3ovmtGlARbbxm4Cek3P3UBxecekNZgv60eil/b6XJ8LlSVhXtPUAzam4250+SkH84sTLbLmGqlQewMJBOkrH07rAeCbdoGQdT/0kRGc5laGLH6Q5Sm2QAJxz2eY8V1ow7UX9woKk8BAJILrNzCr53x+W520P/khyuDQxpaSXpPR0XIPH3OjBfO8rhYqpNIQjmoUmVVixepkmOk6DPGEbQIXCQWaQiYXMsHoBexImXSkWjTvy1FrqPPjEx4fIGeq/nBQUOCSN1jRU4g+WDtV87FTed6Feo+SPzJ1uWVo5BEhYBK0RZIxG3lr1hiGTgX4ZOx8ChJ0OjgNpTY2QLn/3/L37AA2zjLpszXf7V/vvcKdSoo27bMieBOPw1mRZ0D57xpW770BEDVnCcp18jMRxzev7bELtkCS60vMhYxGl5VvcJEKBdQNVPEuoCiCuXWRfK051tg1Ix4SRyAlFK2fshPdQUNJ0y06J/t4qFzBezTXE3sugbkpfc+PawHtLmWz7RtWbt9sN8GPezXM4xsHNQ0XFjJJDO7ChcUwT+jDFk1YIEFLYhb0jchveAyHDDSbe4KKHtnwYI/1D/179gIlH+vZZ3Upot9ZvlB5NS7cNofRh0kSN/f2BzuqNZx36Hl3T+71fS206Qo8A==
    SIS_CLASS_APP_KEY: AgCRMKMYMAEW0M2gGy7stBPC++L/Z3uW6TwqNmPfYz/6S9eBkXWernUOdcaEXa/9amGEKrIhapFGCrKjIKNwM6T4yIqAm5I0JpuoIQQm14yB1GlE+8mG4IYrqyZ2EH9e8Ts0x2YPBfAXymHljo3H+tH4CtUvaO5HYJQwAFvo3yJot5tU1Fr+0rDxtDptwgKdw+2L2kfK2yHH/cccpunnuOyNZeVsNZMhIjE0XAzZdFmwsoLDcGO8q14bx//GxpaJqcSVoaItgKuCICjhPDvZPSmr5iuTRyjtE05bE3yhZeobM1vNt1oRJ4emxF/bC1sKhsiCMrMhC6gykEhtbWsu8M1E5do0qMjKpJ24dDh2mbamOuRjTCrBuuOmXvRJ9m4PeusHJ9+IPSg4JKOiiVwuNvbk6XadagkstYazIrpVgsOohuruKYjnu/KyHhF0i2siyZfiNAlH+667gzy+jDJAA8L8FGOT/FmvkyrarSCiyjCz+keiPODrLsWYCCVlRKiy6ups8xAMRQ38QVgt+z7smHQL0DAJi7qIlcOyFz+2qcrNO9j767kWyJ7oXS5YiP46rFuqejSlSn6rKDa5zZzB1kWJIGjJmEIEvjRqt9LHckgBDs6UWlhXoKD+3SM1ppJqXk3F4kRnJ25OFECt5OP2Fg2RSraAGUoj4h7JhDm0EMpaR5ewzlPWQly4kI35LXmhqBhK9CrJdqTb9m7x/0iWypkSe2OFoiO7Elh3ji+ArS9j8w==
    SIS_COURSE_APP_ID: AgCOyv5vfNF55piWj83dQtD10re4a5LFpkD4qoyRNKio6dhqxtcDbLyLC+DHLoALI545SyqJNMSmpiyYVrxHqYsztWt9ZEvV9IIxdjs3RAyscB/+D3EjetUJ4k1vVdCLn+EfIfn1L3BlvmEecB1KCzDBlANsffq/31bGmJqxJ4rNMfQbRR9XI2PnnQABqPPRWhdTbA7Mk9RGgIY9CsPJ2J73Ig5fwtSoV+4WNhzlsMwf3bm9eWzROWbYQzRh3x0JkOiT6goox4i3nUXv7EV5aDKQfOw7/Y4sZRp1lB1XDXRXz3zeBcl6ZZJL+qbSQyKZK69HZPtth9+PZ9cNUyrfFpeEl9NeHTq2Z8APnGFxvk5kH9IrFKiGXtoBF4boQrKlUQRnbeA9Vk1kxMb48VCK5l87cY4EA8DIlveO05fDtjpJtyrysqyMpjF7D1Ldge/OpAMDXFLk2+k/50zlePgC8KobPvzYT4Fwx9aWySAj+Mhj4viA3p8/hKTzd76r5GDK94sk9A4pB9BZeP1gtm6Es93DdK5wsSz0Tljjg9tbOujUW+XudhSeXtXp1BMvbTIsSWBfyTWBLiKaFtw2aoS5imVIF4kI+XJ+MPyMN56dLntbfZPWCj5+WPYBFeExseZ3bNx1ETQxAa7tcdoC37RqgEX4Ja8B/tiNtSvonfNRRgiQT6mowXoR20g4WDN39TLIB5ilGc/lwX5nVg==
    SIS_COURSE_APP_KEY: AgA3K/mFwUiBaQQAzT3DvV/yjeQ/CHyvDS59yBTcUfxO4ZVCeX7hU79BbM8Y2sO10DsUnupuByRbrk7TpljRP802OiGFBUVOux21CMgUr6Hans296doGe/hLmF5kHQmqD1HzGwJzZb+TQM6JCL+iV0bMTlSubXCjCD5YefG2GH659IGGVbQxYqVU3qrIhU0zZYWAHJR9dVaCbqy5sJs6QF3yW6OHztJHKHHU4YmoRUMPDI004ZGamhrsWK54NSa5iC2qxNrl79kpRhMF0gKx+yv4ltHC6cNAs28mSnBF79ihnb6NCKhU+02baXcGMg/urX2N4O9rAsgYXA+CEXxUZOIqCbIcMzvybb2wFWObi39gH1wejUIleiChxl/dohheJdnMfApX8z0LG6ghTyBpo6XSmeSaefXJnfpI1Eq8Fwe5pkdnx6XnrvVOxiQhl1PwdX/chi4hnSQRAIwLhsjvMmsEUztUQ6jH7bIj7H65B+VxYwTupKwgK5BSfWRtRgQ6xa7doXXlNebZGuMkFauRLdY6DmGOmpYHLXDkSH6x6TdCoNwpCSegSKJNzvpPHKHhlHBM1pNZzY5R1K9CVGfFmFUBzwOBMGxmDYyy9kzo3zL4GrI90k0xmhejhRdZCril0yrs9EkN5Z0PREUbEzGez7iYtmb1nIVKdbx1ftjI5sXewjB2UypHcOGIh1b21Jk+MWb1i0NQ9ccUKPLMV/EvbkrOwK3BrbX7BaBTsJzyEwkSkg==
    SIS_TERM_APP_ID: AgBCvzxEQKBXMEVD+ApmFtrENpuV+XbndAZUsXnTjeoM/g7XdRZojcQKL91KH4C4NDfeHRN07VStDGkh+NhX63nrTPzGpYofDWYMg+Oh1cXR6DhXB1tnAatW22osN/loukFLzv7pTJLp0iztoHesLNqzIfqPbe/mzltwUKs0himI/kFRrPgKd78NmXVP7hVP4+dqtRPd4IxZmiS3f1F0+T8x2Q72li8Zhar6z318wA+Z722qpzBI9WAkQK8MgzuDlXmbWjSIUDsuZaxHPtGlsNEUyUv7IlAv8UP2AMZ05d1TToV9HnHjLqAWiYrEUMMbUi8gbfxONGJD/gosiCxYM6LG7huPRxbW9k5HoZ+h5rZ24fnpCynqFoDSqYTDT6gQHUVTFhoqGQuTXyhxS1NTnPLEpOSmOoQx+QTb6TcK6wEz5XWCLf83VFZa3agPj71RG/KToG4wg+uZSL6nDG+ktDnmpgRl+1mME77qWDw2X1zukX91JQEmU2tcO4xOsTPoOcPDu7FkNZu++L3DeOzhFkdf0hloGPpXOnQWy4FXVtsb7YX1eKDNoTjStKEjrK99EcDNBlknq0L3If86HjgOKY3YGzzJ9eAa6EsGwtgWXWn0UUpV6TEVJNV9l4d/Py9Dd/4L5HSB8VVBv9qHHbo7ZzK6KO/3HOIlycVfHuulV82qcKTDwQIJO0NcTsGMsm7Y2liytr0jGJ/mUA==
    SIS_TERM_APP_KEY: AgAX2aEY4DrROgEF0ZMfGVXkoTXMHEvsYUiSFab3PoVtlICsDbjZLhEQnBQK2WA3LdGqwl7q5doqsbsSW5z2ItyzZDON8/Tp856Ck1qR/d+uFKU6/CWnM35oM6Fz2cuKNVgCsIXHYWBriOMJ2kXRPWA7F6YlYGXTWdU0oryp0yF3eTH48T2nPAu8ZCtRnqImhpRKpXrl5QdLU+31x1MLvl/B8QmJC3ozijQSSifw6vIXhxRO3wiiVEtn3fFeKpDX2fnRFuckFzHJXUXvxi7iOVy+E6aV4rYmo3qqPg3ZwuprLsAvybHlDgZUI7/ziaWptYURvp8AQbcszjh3NKb7mPk52drSpErbpn+Mh1U4b5RGGRBtaiSdgPiKaRwcX415g3DZYV/2C97rzWsAJ04WLioAGG8WQa7+elpKNv53ls+0fm8YImN/yoYnm/tYYU92+0yk4oJgpIcR3BqjLFYL7AQsYupae0fMAQ0d5FOtYDbFObUkzoywle5ywfDv8lQDocSe3EaBtC4ZcMOyJdLocrQyD0pZd/ixiNTpeg7Z0fUfm3WUHPgLKJkg/p8/mmv3HgHhjsZ188S8QpPRuTiAh1WZVRpQUu5LZPHaTmMxm1MOV4hOUHz7FHk0KKDgeuG5m7rrz2mRARJSgTeVlWXp9lkCgNND/2RjiBJ0XDm0lOz28gBOwZDEAfEqbvL3iUt5rzSjf28mHBetzp5CPgCKkG2RfpSip3yFVF+eMkj/C2DGAw==
  template:
    metadata:
      annotations:
        sealedsecrets.bitnami.com/namespace-wide: "true"
      name: {{ include "bt-app.datapullerName" . }}-secret
      labels:
        {{- include "bt-app.datapullerLabels" . | nindent 8 }}

---

{{- range $jobName, $jobConfig := .Values.datapuller.cronjobs }}
{{- include "bt-app.datapuller" (list $ $jobName $jobConfig) }}
---
{{- end }}
