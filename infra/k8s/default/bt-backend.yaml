apiVersion: v1
kind: Service
metadata:
  labels:
    component: bt-backend-$CI_ENVIRONMENT_NAME
  name: bt-backend-$CI_ENVIRONMENT_NAME
  namespace: default
spec:
  ports:
    - name: http-bt-port
      port: 80
      protocol: TCP
      targetPort: 5000
  selector:
    component: bt-backend-$CI_ENVIRONMENT_NAME
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    component: bt-backend-$CI_ENVIRONMENT_NAME
  name: bt-backend-$CI_ENVIRONMENT_NAME
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      component: bt-backend-$CI_ENVIRONMENT_NAME
  template:
    metadata:
      labels:
        component: bt-backend-$CI_ENVIRONMENT_NAME
    spec:
      containers:
        - command:
            - /bin/sh
            - -c
            - |
              node /backend/build
          env:
            - name: NODE_ENV
              value: $CI_ENVIRONMENT_NAE
          envFrom:
            - secretRef:
                name: bt-backend-$CI_ENVIRONMENT_NAME
          image: $GCR_PATH_BACKEND:$CI_COMMIT_SHORT_SHA
          imagePullPolicy: Always
          name: bt-backend-$CI_ENVIRONMENT_NAME
          ports:
            - containerPort: 5000
              protocol: TCP
---
apiVersion: v1
kind: Secret
metadata:
  name: bt-backend-$CI_ENVIRONMENT_NAME
  namespace: default
type: Opaque
stringData:
  EXPIRE_TIME_REDIS_KEY: "$EXPIRE_TIME_REDIS_KEY"
  PORT_EXPRESS: "$PORT_EXPRESS"
  URL_MONGODB: $URL_MONGODB
  URL_REDIS: $URL_REDIS
