---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: bt-backend-data-updater-$CI_ENVIRONMENT_NAME
  namespace: default
spec:
  concurrencyPolicy: Replace
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      activeDeadlineSeconds: 64800
      template:
        metadata:
          labels:
            component: bt-backend-data-updater-$CI_ENVIRONMENT_NAME
        spec:
          shareProcessNamespace: true
          containers:
            - command:
                - node
                - build
              env:
                - name: NODE_ENV
                  value: privileged
              envFrom:
                - secretRef:
                    name: bt-backend-$CI_ENVIRONMENT_NAME
              image: $CI_REGISTRY_IMAGE/bt-backend:$CI_COMMIT_BRANCH
              imagePullPolicy: Always
              name: bt-backend-data-updater-$CI_ENVIRONMENT_NAME
            - command:
                - sh
                - -c
                - |
                  until curl http://localhost:5000/api/health; do sleep 5; echo waiting for backend...; done;
                  curl http://localhost:5000/api/sis_courses/requestDump
                  curl http://localhost:5000/api/sis_courses/parseDump
                  curl http://localhost:5000/api/sis_classes/requestClassDump
                  curl http://localhost:5000/api/sis_class_sections/requestClassSectionDump
                  curl http://localhost:5000/api/calanswers_grades/parseGradeDump
                  pkill node
              env:
                - name: NODE_ENV
                  value: privileged
              envFrom:
                - secretRef:
                    name: bt-backend-$CI_ENVIRONMENT_NAME
              securityContext:
                runAsUser: 0
              image: curlimages/curl
              imagePullPolicy: Always
              name: curl
              ports:
                - containerPort: 5000
                  protocol: TCP
          restartPolicy: OnFailure
  schedule: 0 0 * * *
  successfulJobsHistoryLimit: 1
