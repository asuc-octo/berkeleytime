/**   (c) 2011 James Cryer, Huddle (www.huddle.com) 	*/
/**   http://jamescryer.github.com/grumble.js/ 		*/
(function(e,t){var n={type:"",text:"",top:0,left:0,angle:45,size:50,distance:50,template:'<div class="grumble" style="display:none;filter:progid:DXImageTransform.Microsoft.Matrix(sizingMethod=\'auto expand\')">&#160;</div>',textTemplate:'<div class="grumble-text" style="display:none;"><div class="outer"><div class="inner">{text}</div></div></div>',context:null};t.GrumbleBubble=function(t){this.options=e.extend({},n,t);this.context=e(this.options.context||e("body"));this.css={};this.create()};t.GrumbleBubble.prototype={create:function(){var n=t.GrumbleBubble.prototype.tmpl;this.bubble=e(n(this.options.template));this.text=e(n(this.options.textTemplate,{text:this.options.text}));this.prepare()},setBubbleRotation:function(){this.rotateDeg=this.options.angle-45;if(this.rotateDeg<0){this.rotateDeg+=360}},prepare:function(){var e=this.bubble.get(0).parentNode;this.setBubbleRotation();this.applyStyles();if(e!==this.context){this.append()}this.rotate()},applyStyles:function(){this.setPosition();this.css.width=this.options.size;this.css.height=this.options.size;this.text.css(this.css).addClass("grumble-text"+this.options.size);this.bubble.css(this.css).addClass(this.options.type+"grumble"+this.options.size);this.realLeft=this.css.left;this.realTop=this.css.top},setPosition:function(){var e=this.options.angle/-360,t=Math.cos(e*2*Math.PI),n=Math.sin(e*2*Math.PI),r=this.options.size/2,i=this.options.size*this.options.size,s=Math.sqrt(i+i)/2,o=this.options.top+r-t*(this.options.distance+s),u=this.options.left-r-n*(this.options.distance+s);this.css.top=o-this.options.size;this.css.left=u},append:function(){var e=this.context;this.bubble.appendTo(e);this.text.appendTo(e)},rotate:function(){if(navigator.appName==="Microsoft Internet Explorer"&&t.document.documentMode<10){this.ieRotate()}else{this.cssRotate()}},cssRotate:function(){this.bubble.css({"-moz-transform":"rotate("+this.rotateDeg+"deg)","-webkit-transform":"rotate("+this.rotateDeg+"deg)","-o-transform":"rotate("+this.rotateDeg+"deg)",transform:"rotate("+this.rotateDeg+"deg)"})},ieRotate:function(){var e=this.rotateDeg,t=Math.PI*2/360,n=e*t,r=Math.cos(n),i=Math.sin(n),s=this.bubble.get(0),o,u;s.filters.item(0).M11=r;s.filters.item(0).M12=-i;s.filters.item(0).M21=i;s.filters.item(0).M22=r;o=this.bubble.width();u=this.bubble.height();this.bubble.css({left:this.css.left-(o-this.options.size)/2,top:this.css.top-(u-this.options.size)/2})},adjust:function(t){e.extend(this.options,t);this.prepare()},tmpl:function(e,t,n){for(var r in t){if(t[r]===null)t[r]="";if(typeof t[r]==="object"&&t[r].length){t[r]=t[r].join(", ")}e=e.replace(new RegExp("{"+r+"}","g"),n?escape(t[r]):t[r])}return e}}})($,window)